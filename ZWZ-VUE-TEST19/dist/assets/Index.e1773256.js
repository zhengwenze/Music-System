import{E as e,n as a,u as l,o as t}from"./element-plus.c63ee1ff.js";import{g as s,a as u,m as r,b as o}from"./msg.2d383b74.js";import{_ as i}from"./index.cfbf38c0.js";import{r as d,j as n,c as m,o as v,ac as c,y as g,D as p,G as f,E as y,F as h,z as _,R as w,M as k,a5 as b,S as x,U as V,u as D,H as T}from"./vendor.1112e821.js";import"./axios.468b7dd2.js";const C={class:"container",key:"message-container"},I={class:"header"},R={class:"header-actions"},S={key:0,class:"badge"},U={class:"message-container"},j={key:2,class:"message-list"},F=["onClick"],M={class:"message-header"},$={class:"message-title"},q={class:"message-time"},E={class:"message-preview"},z={key:0},A={class:"dialog-header"},H={class:"dialog-time"},N={class:"dialog-content"},G={key:1,class:"empty-dialog"};var P=i({__name:"Index",setup(i){const P=d([]),Y=d(0),B=d(!1),J=d(!1),K=d(!1),L=d(!1),O=d(null),Q=d(null),W=d({title:"",message:"",togroup:"",username:""}),X=n({title:[{required:!0,message:"请输入消息标题",trigger:"blur"},{max:50,message:"标题最多50个字符",trigger:"blur"}],message:[{required:!0,message:"请输入消息内容",trigger:"blur"},{max:200,message:"内容最多200个字符",trigger:"blur"}],togroup:[{required:!0,message:"请选择发送角色",trigger:"change"}],username:[{required:()=>"0"===W.value.togroup,message:"请输入用户ID",trigger:"blur"}]}),Z=m((()=>Y.value>0)),ee=async()=>{var a,l,t,u;if(!B.value){B.value=!0;try{const r=await s();(null==(a=null==r?void 0:r.data)?void 0:a.success)?(P.value=Array.isArray(null==(t=null==(l=r.data)?void 0:l.data)?void 0:t.msg)?r.data.data.msg:[],P.value.sort(((e,a)=>{const l=e.createTime?new Date(e.createTime).getTime():0;return(a.createTime?new Date(a.createTime).getTime():0)-l})),P.value.forEach((e=>{void 0===e.isRead&&(e.isRead=1)}))):e.error((null==(u=null==r?void 0:r.data)?void 0:u.message)||"获取消息失败，请检查网络连接")}catch(r){e.error("获取消息失败，请稍后重试")}finally{B.value=!1}}},ae=async()=>{await ee(),await le()},le=async()=>{var e,a,l;try{const t=await u();(null==(e=null==t?void 0:t.data)?void 0:e.success)&&(Y.value=parseInt(null==(l=null==(a=t.data)?void 0:a.data)?void 0:l.unReadMsg)||0)}catch(t){}},te=async()=>{var a,l;if(Z.value)try{const t=await r();(null==(a=null==t?void 0:t.data)?void 0:a.success)?(e.success("已全部标记为已读"),P.value.forEach((e=>{e.isRead=1})),Y.value=0):e.error((null==(l=null==t?void 0:t.data)?void 0:l.message)||"标记失败，请稍后重试")}catch(t){e.error("标记失败，请稍后重试")}},se=((e,a)=>{let l=null;return function(...t){l&&clearTimeout(l),l=setTimeout((()=>{e.apply(this,t)}),a)}})((e=>{e&&(O.value={...e},K.value=!0,0===e.isRead&&Y.value>0&&(e.isRead=1,Y.value=Math.max(0,Y.value-1)))}),200),ue=async()=>{var a,l;try{await Q.value.validate();const t={title:W.value.title.trim(),message:W.value.message.trim(),togroup:"0"===W.value.togroup?"":W.value.togroup,username:"0"===W.value.togroup?W.value.username.trim():null};if("0"===W.value.togroup&&!t.username)return void e.warning("请输入用户ID");J.value=!0;const s=await o(t.title,t.message,t.togroup,t.username);(null==(a=null==s?void 0:s.data)?void 0:a.success)?(e.success("发送成功"),W.value={title:"",message:"",togroup:"",username:""},Q.value.resetFields(),re(),ee()):e.error("发送失败: "+((null==(l=null==s?void 0:s.data)?void 0:l.message)||"未知错误"))}catch(t){e.error("发送失败，请重试")}finally{J.value=!1}},re=()=>{L.value=!1},oe=()=>{W.value.title="",W.value.message="",W.value.togroup="",W.value.username="",Q.value&&Q.value.resetFields(),re()},ie=e=>{if(!e)return"时间未知";try{const a=new Date(e);return isNaN(a.getTime())?"时间格式错误":`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`}catch(a){return"时间未知"}};return v((async()=>{try{await Promise.all([ee(),le()])}catch(e){}})),(e,s)=>{const u=c("el-button"),r=c("el-icon"),o=c("el-empty"),i=c("el-dialog"),d=c("el-input"),n=c("el-form-item"),m=c("el-option"),v=c("el-select"),Z=c("el-form");return g(),p("div",C,[f("div",I,[s[11]||(s[11]=f("h2",null,"消息中心",-1)),f("div",R,[y(u,{type:"primary",onClick:ae},{default:h((()=>[...s[8]||(s[8]=[x(" 刷新 ",-1)])])),_:1}),y(u,{type:"primary",onClick:s[0]||(s[0]=e=>L.value=!0)},{default:h((()=>[...s[9]||(s[9]=[x(" 发送消息 ",-1)])])),_:1}),Y.value>0?(g(),_(u,{key:0,onClick:te},{default:h((()=>[s[10]||(s[10]=x(" 全部标记已读 ",-1)),Y.value>0?(g(),p("span",S,V(Y.value),1)):w("",!0)])),_:1})):w("",!0)])]),f("div",U,[B.value?(g(),_(o,{key:0,description:"加载中..."},{default:h((()=>[y(r,{size:"40",color:"#409eff"},{default:h((()=>[y(D(a))])),_:1})])),_:1})):0===P.value.length?(g(),_(o,{key:1,description:"暂无消息"},{default:h((()=>[y(u,{type:"primary",onClick:ee},{default:h((()=>[...s[12]||(s[12]=[x("刷新",-1)])])),_:1})])),_:1})):(g(),p("div",j,[(g(!0),p(k,null,b(P.value,(e=>{return g(),p("div",{key:e.id,class:T(["message-item",{unread:0===e.isRead}]),onClick:a=>D(se)(e)},[f("div",M,[f("span",$,V(e.title||"无标题消息"),1),f("span",q,V(ie(e.createTime)),1)]),f("div",E,V((a=e.msg||"无内容",l=100,a&&"string"==typeof a?a.length<=l?a:a.substring(0,l)+"...":"")),1)],10,F);var a,l})),128))]))]),y(i,{modelValue:K.value,"onUpdate:modelValue":s[1]||(s[1]=e=>K.value=e),title:"消息详情",width:"600px"},{default:h((()=>[O.value?(g(),p("div",z,[f("div",A,[f("h3",null,V(O.value.title||"无标题消息"),1),f("span",H,V(ie(O.value.createTime)),1)]),f("div",N,[f("p",null,V(O.value.msg||"无内容"),1)])])):(g(),p("div",G,[...s[13]||(s[13]=[f("p",null,"消息内容加载失败",-1)])]))])),_:1},8,["modelValue"]),y(i,{modelValue:L.value,"onUpdate:modelValue":s[7]||(s[7]=e=>L.value=e),title:"发送消息",width:"600px","close-on-click-modal":!1},{footer:h((()=>[y(u,{onClick:oe},{default:h((()=>[...s[16]||(s[16]=[x("取消",-1)])])),_:1}),y(u,{type:"primary",loading:J.value,onClick:ue},{default:h((()=>[...s[17]||(s[17]=[x("发送",-1)])])),_:1},8,["loading"])])),default:h((()=>[y(Z,{ref_key:"sendFormRef",ref:Q,model:W.value,rules:X,"label-width":"80px"},{default:h((()=>[y(n,{label:"消息标题",prop:"title"},{default:h((()=>[y(d,{modelValue:W.value.title,"onUpdate:modelValue":s[2]||(s[2]=e=>W.value.title=e),placeholder:"请输入消息标题",maxlength:"50","show-word-limit":""},null,8,["modelValue"])])),_:1}),y(n,{label:"消息内容",prop:"message"},{default:h((()=>[y(d,{modelValue:W.value.message,"onUpdate:modelValue":s[3]||(s[3]=e=>W.value.message=e),type:"textarea",rows:"4",placeholder:"请输入消息内容",maxlength:"500","show-word-limit":""},null,8,["modelValue"])])),_:1}),y(n,{label:"发送角色",prop:"togroup"},{default:h((()=>[y(v,{modelValue:W.value.togroup,"onUpdate:modelValue":s[4]||(s[4]=e=>W.value.togroup=e),placeholder:"请选择发送角色"},{default:h((()=>[y(m,{label:"全体用户",value:"2"}),y(m,{label:"全体歌手",value:"1"}),y(m,{label:"特定用户",value:"0"})])),_:1},8,["modelValue"])])),_:1}),"0"===W.value.togroup?(g(),_(n,{key:0,label:"用户ID",prop:"username"},{default:h((()=>[y(d,{modelValue:W.value.username,"onUpdate:modelValue":s[6]||(s[6]=e=>W.value.username=e),placeholder:"请输入用户ID",maxlength:"50","show-word-limit":""},{prefix:h((()=>[y(r,null,{default:h((()=>[y(D(l))])),_:1})])),suffix:h((()=>[W.value.username?(g(),_(r,{key:0,class:"el-input__icon",onClick:s[5]||(s[5]=e=>W.value.username="")},{default:h((()=>[y(D(t))])),_:1})):w("",!0)])),_:1},8,["modelValue"]),s[14]||(s[14]=f("div",{class:"help-text"},"请输入接收消息的具体用户ID",-1))])),_:1})):w("",!0),s[15]||(s[15]=f("div",{class:"help-text"},"选择'所有人'或'歌手'向对应角色的用户群组发送消息，或选择'特定用户'向单个用户ID发送消息",-1))])),_:1},8,["model","rules"])])),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-3afbaa8c"]]);export{P as default};
