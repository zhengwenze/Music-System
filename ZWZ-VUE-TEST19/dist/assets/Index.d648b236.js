import{r as e,j as a,o as r,ac as l,ad as t,y as s,D as i,E as o,F as u,G as n,am as c,S as d,P as m,z as g,U as p}from"./vendor.1112e821.js";import{g as f,f as h,a as v,e as w,b as y}from"./admin.d2f1ae71.js";import{a as b,u as U}from"./upload.2e887d46.js";import{_}from"./index.cfbf38c0.js";import{E as C,i as F}from"./element-plus.c63ee1ff.js";import"./axios.468b7dd2.js";const x={class:"music-management-container"},E={class:"search-box"},I={key:1},S={style:{display:"flex",gap:"10px","align-items":"center"}},V={style:{display:"flex",gap:"10px","align-items":"center"}},j={key:0,class:"image-preview"},k={key:1,class:"image-placeholder"},M={class:"dialog-footer"};var P=_({name:"MusicManagement",setup(){const l=e([]),t=e(!1),s=e(0),i=e(1),o=e(5),u=e(""),n=e(!1),c=e(""),d=e(null),m=e(!1),g=a({musicId:null,musicName:"",musicUrl:"",imageUrl:"",timeLength:null,listenNumb:0,fromSinger:null,tags:"",activation:0}),p=e([]),_=e([]),x=e(null),E=e(null),I=a({musicId:[{validator:(e,a,r)=>{!m.value||a&&null!==a?r():r(new Error("音乐ID不能为空"))},trigger:"blur"}],musicName:[{required:!0,message:"请输入音乐名称",trigger:"blur"},{min:1,max:50,message:"音乐名称长度在 1 到 50 个字符",trigger:"blur"}],musicUrl:[{required:!0,message:"请上传音乐文件",trigger:"blur"}],imageUrl:[{required:!0,message:"请上传封面图片",trigger:"blur"}]}),S=async()=>{var e,a,r,n,c,d,m;t.value=!0;try{const g=await f({page:i.value,size:o.value,name:u.value});20===(null==(e=g.data)?void 0:e.code)||!0===(null==(a=g.data)?void 0:a.success)?(l.value=(null==(n=null==(r=g.data.data)?void 0:r.page)?void 0:n.records)||[],s.value=(null==(d=null==(c=g.data.data)?void 0:c.page)?void 0:d.total)||0):C.error((null==(m=g.data)?void 0:m.message)||"获取音乐列表失败")}catch(g){C.error("获取音乐列表失败")}finally{t.value=!1}},V=()=>{g.musicId=null,g.musicName="",g.musicUrl="",g.imageUrl="",g.timeLength=null,g.fromSinger=null,g.tags="",g.listenNumb=0,g.activation=0,d.value&&d.value.resetFields(),p.value=[],_.value=[],x.value=null,E.value=null},j=async e=>{try{if(!e||"object"!=typeof e)throw new Error("无效的选项参数");const{file:a,onProgress:r,onSuccess:l,onError:t}=e;let s=a;if(!a)throw new Error("无效的文件对象：文件参数为空");if(a instanceof File)s=a;else{if(!(a.raw&&a.raw instanceof File))throw new Error("无效的文件对象：不是File实例且没有有效的raw属性");s=a.raw}const i=e=>{if(e.total){const l=Math.round(100*e.loaded/e.total);r&&r({percent:l}),a&&(a.percentage=l)}},o=await b(s,i);if(!o)throw new Error("API返回空结果");const u=o||{};let n=!1,c="",d=0;if(u.url?(n=!0,c=u.url,d=u.timelength||0):(!0===u.success||20===u.code)&&u.data&&u.data.url&&(n=!0,c=u.data.url,d=u.data.timelength||0),n){if(!c||""===c.trim())throw new Error("API返回的数据中没有有效的URL");const e={success:!0,message:u.message||"音乐文件上传成功",data:{url:c,timelength:d}};return x.value=e,g.musicUrl=c,d>0&&(g.timeLength=d),a&&(a.status="success",a.url=c,a.percentage=100),l&&l({status:"success",data:c}),Promise.resolve({status:"success",data:c})}{const e=u.message||"上传失败，API返回错误";throw new Error(e)}}catch(a){const r=a.message||"音乐文件上传失败";return x.value={success:!1,message:r},g.musicUrl="",e&&e.file&&(e.file.status="error",e.file.url="",e.file.percentage=0),e&&e.onError&&e.onError(a),C.error(r),Promise.reject(a)}},k=async e=>{try{if(!e||"object"!=typeof e)throw new Error("无效的选项参数");const{file:a,onProgress:r,onSuccess:l,onError:t}=e;let s=a;if(a instanceof File)s=a;else{if(!(a.raw&&a.raw instanceof File))throw new Error("无效的文件对象");s=a.raw}const i=await U(s);if(!i)throw new Error("API返回空结果");let o="";if("string"==typeof i)o=i;else if(i.url)o=i.url;else if(i.data&&i.data.url)o=i.data.url;else{if(!i.data)throw new Error("无法从响应中提取有效的图片URL");o=i.data}if(!o||"string"!=typeof o)throw new Error("无法从响应中提取有效的图片URL");return g.imageUrl=o,x.value={success:!0,message:"图片上传成功",url:o},a&&(a.status="success",a.url=o,a.percentage=100),l&&l({status:"success",data:o}),C.success("图片上传成功"),{success:!0,url:o}}catch(a){const r=a.message||"图片文件上传失败";return x.value={success:!1,message:r},g.imageUrl="",e&&e.file&&(e.file.status="error",e.file.url="",e.file.percentage=0),e&&e.onError&&e.onError(a),C.error(r),Promise.reject(a)}};return r((()=>{S()})),{musicList:l,loading:t,total:s,currentPage:i,pageSize:o,searchKeyword:u,handleSearch:()=>{i.value=1,S()},resetSearch:()=>{u.value="",i.value=1,S()},fresh:()=>{S()},toggleMusicStatus:async e=>{var a,r,l,t;try{await F.confirm(`确定要${1===e.activation?"冻结":"解冻"}音乐 "${e.musicName}" 吗？`,"确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});let s;s=1===e.activation?await h(e.musicId):await v(e.musicId),20===(null==(a=s.data)?void 0:a.code)||!0===(null==(r=s.data)?void 0:r.success)||20===s.code?(C.success((null==(l=s.data)?void 0:l.message)||(1===e.activation?"冻结":"解冻")+"成功"),S()):C.error((null==(t=s.data)?void 0:t.message)||(1===e.activation?"冻结":"解冻")+"失败")}catch(s){"cancel"===s||C.error("操作失败")}},handleSizeChange:e=>{o.value=e,i.value=1,S()},handleCurrentChange:e=>{i.value=e,S()},dialogVisible:n,dialogTitle:c,musicForm:g,musicFormRef:d,formRules:I,showAddForm:()=>{m.value=!1,c.value="添加音乐",V(),n.value=!0},showEditForm:e=>{m.value=!0,c.value="编辑音乐",Object.assign(g,e),n.value=!0},submitForm:async()=>{d.value&&await d.value.validate((async e=>{if(!e)return!1;try{let e,a={...g};if(e=m.value?await w(a):await y(a),e.data){const a=e.data;20===a.code||!0===a.success?(C.success(a.message||(m.value?"更新成功":"添加成功")),n.value=!1,S()):C.error(a.message||(m.value?"更新失败":"添加失败"))}else 20===e.code||!0===e.success?(C.success(m.value?"更新成功":"添加成功"),n.value=!1,S()):C.error(e.message||(m.value?"更新失败":"添加失败"))}catch(a){C.error("操作失败")}}))},isEditMode:m,formatDuration:e=>{if(!e||isNaN(e))return"00:00";const a=Math.floor(e/60),r=Math.floor(e%60);return`${a.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`},beforeMusicUpload:e=>{if(!["audio/mpeg","audio/wav","audio/flac","audio/mp4"].includes(e.type))return C.error("上传文件必须是音频格式!"),!1;return!!(e.size/1024/1024<10)||(C.error("上传文件大小不能超过 10MB!"),!1)},customMusicUpload:j,handleMusicChange:(e,a)=>{p.value=a,"success"===e.status?e.url&&e.url.trim()?g.musicUrl=e.url:g.musicUrl="":("error"===e.status||"removed"===e.status)&&(g.musicUrl="")},handleMusicUpload:async()=>{const e=p.value[0];if(!e)return C.error("请选择音乐文件后再上传"),Promise.reject(new Error("未选择音乐文件"));x.value={success:!1,message:""},g.musicUrl="";try{return await j({file:e,onProgress:e=>{},onSuccess:e=>{},onError:e=>{}})}catch(a){return C.error(a.message||"音乐文件上传失败"),Promise.reject(a)}},beforeImageUpload:e=>{if(!["image/jpeg","image/png","image/gif"].includes(e.type))return C.error("上传文件必须是图片格式!"),!1;return!!(e.size/1024/1024<5)||(C.error("上传文件大小不能超过 5MB!"),!1)},customImageUpload:k,handleImageChange:(e,a)=>{_.value=a,"success"===e.status?e.url&&e.url.trim()?g.imageUrl=e.url:g.imageUrl="":("error"===e.status||"removed"===e.status)&&(g.imageUrl="")},handleImageUpload:async()=>{const e=_.value[0];if(!e)return C.error("请选择封面图片后再上传"),Promise.reject(new Error("未选择图片文件"));x.value={success:!1,message:""},g.imageUrl="";try{return await k({file:e,onProgress:e=>{},onSuccess:e=>{},onError:e=>{}})}catch(a){return C.error(a.message||"图片文件上传失败"),Promise.reject(a)}},musicFileList:p,imageFileList:_,uploadResult:x}}},[["render",function(e,a,r,f,h,v){const w=l("el-input"),y=l("el-button"),b=l("el-table-column"),U=l("el-image"),_=l("el-tag"),C=l("el-table"),F=l("el-pagination"),P=l("el-card"),z=l("el-form-item"),L=l("el-upload"),N=l("el-form"),R=l("el-dialog"),q=t("loading");return s(),i("div",x,[o(P,null,{default:u((()=>[a[14]||(a[14]=n("div",{class:"card-header"},[n("h2",null,"音乐管理")],-1)),n("div",E,[o(w,{modelValue:f.searchKeyword,"onUpdate:modelValue":a[0]||(a[0]=e=>f.searchKeyword=e),placeholder:"请输入音乐名称进行搜索",style:{width:"300px","margin-right":"10px"},clearable:"",onKeyup:c(f.handleSearch,["enter"])},null,8,["modelValue","onKeyup"]),o(y,{type:"primary",onClick:f.handleSearch},{default:u((()=>[...a[10]||(a[10]=[d("搜索",-1)])])),_:1},8,["onClick"]),o(y,{onClick:f.resetSearch},{default:u((()=>[...a[11]||(a[11]=[d("重置",-1)])])),_:1},8,["onClick"]),o(y,{onClick:f.fresh},{default:u((()=>[...a[12]||(a[12]=[d("刷新",-1)])])),_:1},8,["onClick"])]),m((s(),g(C,{data:f.musicList,style:{"margin-top":"20px"},"default-sort":{prop:"musicId",order:"ascending"}},{default:u((()=>[o(b,{prop:"musicId",label:"ID",width:"50"}),o(b,{prop:"musicName",label:"音乐名称",width:"150"}),o(b,{label:"音乐封面",width:"150"},{default:u((({row:e})=>[e.imageUrl?(s(),g(U,{key:0,src:e.imageUrl,"preview-src-list":[e.imageUrl],fit:"cover",style:{width:"80px",height:"80px","border-radius":"4px"}},null,8,["src","preview-src-list"])):(s(),i("span",I,"-"))])),_:1}),o(b,{label:"歌手",width:"120"},{default:u((({row:e})=>[d(p(e.singerUsername||"-"),1)])),_:1}),o(b,{prop:"tags",label:"标签",width:"150","show-overflow-tooltip":""}),o(b,{prop:"timeLength",label:"时长",width:"80"},{default:u((({row:e})=>[d(p(f.formatDuration(e.timeLength)),1)])),_:1}),o(b,{prop:"listenNumb",label:"播放量",width:"80"}),o(b,{prop:"activation",label:"状态",width:"80"},{default:u((({row:e})=>[o(_,{type:1===e.activation?"success":"danger"},{default:u((()=>[d(p(1===e.activation?"正常":"冻结"),1)])),_:2},1032,["type"])])),_:1}),o(b,{prop:"createTime",label:"创建时间",width:"160"}),o(b,{label:"操作",width:"180"},{default:u((({row:e})=>[o(y,{size:"small",type:"primary",onClick:a=>f.showEditForm(e),style:{"margin-right":"5px"}},{default:u((()=>[...a[13]||(a[13]=[d(" 编辑 ",-1)])])),_:1},8,["onClick"]),o(y,{size:"small",type:1===e.activation?"danger":"success",onClick:a=>f.toggleMusicStatus(e)},{default:u((()=>[d(p(1===e.activation?"冻结":"解冻"),1)])),_:2},1032,["type","onClick"])])),_:1})])),_:1},8,["data"])),[[q,f.loading]]),o(F,{"current-page":f.currentPage,"onUpdate:currentPage":a[1]||(a[1]=e=>f.currentPage=e),"page-size":f.pageSize,"onUpdate:pageSize":a[2]||(a[2]=e=>f.pageSize=e),"page-sizes":[5,10,20,50,100],total:f.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:f.handleSizeChange,onCurrentChange:f.handleCurrentChange,style:{"margin-top":"20px","justify-content":"center"}},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])),_:1}),o(R,{modelValue:f.dialogVisible,"onUpdate:modelValue":a[9]||(a[9]=e=>f.dialogVisible=e),title:f.dialogTitle,width:"500px"},{footer:u((()=>[n("span",M,[o(y,{onClick:a[8]||(a[8]=e=>f.dialogVisible=!1)},{default:u((()=>[...a[21]||(a[21]=[d("取消",-1)])])),_:1}),o(y,{type:"primary",onClick:f.submitForm},{default:u((()=>[...a[22]||(a[22]=[d("确定",-1)])])),_:1},8,["onClick"])])])),default:u((()=>[o(N,{ref:"musicFormRef",model:f.musicForm,rules:f.formRules,"label-width":"80px"},{default:u((()=>[o(z,{label:"音乐ID",prop:"musicId"},{default:u((()=>[o(w,{modelValue:f.musicForm.musicId,"onUpdate:modelValue":a[3]||(a[3]=e=>f.musicForm.musicId=e),placeholder:"音乐ID",readonly:"",disabled:!0},null,8,["modelValue"])])),_:1}),o(z,{label:"音乐名称",prop:"musicName"},{default:u((()=>[o(w,{modelValue:f.musicForm.musicName,"onUpdate:modelValue":a[4]||(a[4]=e=>f.musicForm.musicName=e),placeholder:"请输入音乐名称"},null,8,["modelValue"])])),_:1}),o(z,{label:"标签",prop:"tags"},{default:u((()=>[o(w,{modelValue:f.musicForm.tags,"onUpdate:modelValue":a[5]||(a[5]=e=>f.musicForm.tags=e),placeholder:"请输入标签（用逗号分隔）"},null,8,["modelValue"])])),_:1}),o(z,{label:"选择音乐文件"},{tip:u((()=>[...a[17]||(a[17]=[n("div",{class:"el-upload__tip"}," 只能上传 mp3/wav/flac/m4a 格式的音频文件，且不超过 10MB，最多上传1个文件 ",-1)])])),default:u((()=>[n("div",S,[o(L,{action:"","before-upload":f.beforeMusicUpload,"http-request":f.customMusicUpload,"before-remove":e.beforeRemove,"auto-upload":!1,"file-list":f.musicFileList,accept:".mp3,.wav,.flac,.m4a",onChange:f.handleMusicChange,limit:1,"on-exceed":e.handleExceed},{default:u((()=>[o(y,{type:"primary"},{default:u((()=>[...a[15]||(a[15]=[d("选择文件",-1)])])),_:1})])),_:1},8,["before-upload","http-request","before-remove","file-list","onChange","on-exceed"]),o(y,{type:"primary",onClick:f.handleMusicUpload},{default:u((()=>[...a[16]||(a[16]=[d(" 上传 ",-1)])])),_:1},8,["onClick"])])])),_:1}),o(z,{label:"音乐URL",prop:"musicUrl"},{default:u((()=>[o(w,{modelValue:f.musicForm.musicUrl,"onUpdate:modelValue":a[6]||(a[6]=e=>f.musicForm.musicUrl=e),placeholder:" ",readonly:"",disabled:""},null,8,["modelValue"])])),_:1}),o(z,{label:"选择封面图片"},{tip:u((()=>[...a[20]||(a[20]=[n("div",{class:"el-upload__tip"}," 只能上传 jpg/jpeg/png/gif 格式的图片文件，且不超过 5MB，最多上传1个文件 ",-1)])])),default:u((()=>[n("div",V,[o(L,{action:"","before-upload":f.beforeImageUpload,"http-request":f.customImageUpload,"before-remove":e.beforeRemove,"auto-upload":!1,"file-list":f.imageFileList,accept:".jpg,.jpeg,.png,.gif",onChange:f.handleImageChange,limit:1,"on-exceed":e.handleExceed},{default:u((()=>[o(y,{type:"primary"},{default:u((()=>[...a[18]||(a[18]=[d("选择封面",-1)])])),_:1})])),_:1},8,["before-upload","http-request","before-remove","file-list","onChange","on-exceed"]),o(y,{type:"primary",onClick:f.handleImageUpload},{default:u((()=>[...a[19]||(a[19]=[d(" 上传 ",-1)])])),_:1},8,["onClick"])])])),_:1}),o(z,{label:"封面预览"},{default:u((()=>[f.musicForm.imageUrl?(s(),i("div",j,[o(U,{src:f.musicForm.imageUrl,"preview-src-list":[f.musicForm.imageUrl],fit:"cover",style:{width:"200px",height:"200px","border-radius":"4px"}},null,8,["src","preview-src-list"])])):(s(),i("div",k," 暂无封面图片 "))])),_:1}),o(z,{label:"图片URL",prop:"imageUrl"},{default:u((()=>[o(w,{modelValue:f.musicForm.imageUrl,"onUpdate:modelValue":a[7]||(a[7]=e=>f.musicForm.imageUrl=e),placeholder:" ",readonly:"",disabled:""},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"])])}],["__scopeId","data-v-0f79f885"]]);export{P as default};
