import{a as e}from"./singer.7d3633a2.js";import{a as r,u as a}from"./upload.2e887d46.js";import{_ as s,g as t,a as l}from"./index.cfbf38c0.js";import{E as u,i as o}from"./element-plus.c63ee1ff.js";import{j as i,o as n,r as c,ac as m,y as d,D as g,G as f,E as p,F as v,z as y,R as w,S as h,U}from"./vendor.1112e821.js";import"./axios.468b7dd2.js";const b={class:"upload-music-container"},_={style:{display:"flex",gap:"10px","align-items":"center"}},E={style:{display:"flex",gap:"10px","align-items":"center"}},j={key:0,class:"image-preview"},x=["src"],P={key:1,class:"image-placeholder"},V={class:"button-group"},k={key:0,class:"upload-result"},R={key:1},F={key:1,class:"submit-result"};var I=s({__name:"Index",setup(s){const I=i({musicName:"",singerUsername:"",musicUrl:"",imageUrl:""});n((async()=>{await B()}));const B=async()=>{try{const e=t();if(!e)return void u.error("用户未登录");const r=await l(e);if(r&&r.data&&(r.data.success||20===r.data.code)&&r.data.data&&r.data.data.user){const e=r.data.data.user;I.singerUsername=e.username||""}}catch(e){}},L={musicName:[{required:!0,message:"请输入音乐名称",trigger:"blur"},{min:1,max:50,message:"音乐名称长度应在1-50个字符之间",trigger:"blur"}],singerUsername:[{required:!0,message:"请输入歌手用户名",trigger:"blur"},{min:1,max:50,message:"歌手用户名长度应在1-50个字符之间",trigger:"blur"}]},M=c(null),S=c([]),$=c([]),q=c(null),A=c(null);c(1);const C=(e,r)=>{u.warning(`当前限制选择 1 个文件，本次选择了 ${e.length} 个文件，共选择了 ${e.length+r.length} 个文件`)},N=(e,r)=>{try{return o.confirm(`确定移除 ${e.name}？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).catch((()=>!1))}catch(a){return!1}},z=e=>{if(!["audio/mpeg","audio/wav","audio/flac","audio/mp4"].includes(e.type))return u.error("上传文件必须是音频格式!"),!1;return!!(e.size/1024/1024<10)||(u.error("上传文件大小不能超过 10MB!"),!1)},T=e=>{if(!["image/jpeg","image/png","image/gif"].includes(e.type))return u.error("上传文件必须是图片格式!"),!1;return!!(e.size/1024/1024<5)||(u.error("上传文件大小不能超过 5MB!"),!1)},D=async e=>{try{if(!e||"object"!=typeof e)throw new Error("无效的选项参数");const{file:a,onProgress:s,onSuccess:t,onError:l}=e;let u=a;if(!a)throw new Error("无效的文件对象：文件参数为空");if(a instanceof File)u=a;else{if(!(a.raw&&a.raw instanceof File))throw new Error("无效的文件对象：不是File实例且没有有效的raw属性");u=a.raw}const o=e=>{if(e.total){const r=Math.round(100*e.loaded/e.total);s&&s({percent:r}),a&&(a.percentage=r)}},i=await r(u,o);if(!i)throw new Error("API返回空结果");const n=i||{};let c=!1,m="",d=0;if(n.url?(c=!0,m=n.url,d=n.timelength||0):(!0===n.success||20===n.code)&&n.data&&n.data.url&&(c=!0,m=n.data.url,d=n.data.timelength||0),c){if(!m||""===m.trim())throw new Error("API返回的数据中没有有效的URL");const e={success:!0,message:n.message||"音乐文件上传成功",data:{url:m,timelength:d}};return q.value=e,I.musicUrl=m,a&&(a.status="success",a.url=m,a.percentage=100),t&&t({status:"success",data:m}),Promise.resolve({status:"success",data:m})}{const e=n.message||"上传失败，API返回错误";throw new Error(e)}}catch(a){const r=a.message||"音乐文件上传失败";return q.value={success:!1,message:r},I.musicUrl="",e&&e.file&&(e.file.status="error",e.file.url="",e.file.percentage=0),e&&e.onError&&e.onError(a),u.error(r),Promise.reject(a)}},G=async e=>{var r;try{if(!e||"object"!=typeof e)return u.error("上传配置错误"),null==(r=null==e?void 0:e.onError)||r.call(e,{message:"上传配置错误"}),Promise.reject(new Error("上传配置错误"));let{file:s,onProgress:t,onSuccess:l,onError:o}=e;if(!s)return u.error("请选择要上传的文件"),null==o||o({message:"请选择要上传的文件"}),Promise.reject(new Error("请选择要上传的文件"));const i=s.raw||s;if(!(i instanceof File))return u.error("无效的文件类型"),null==o||o({message:"无效的文件类型"}),Promise.reject(new Error("无效的文件类型"));const n=await a(i);if(!n)throw new Error("上传API返回空结果");let c="";if(c="string"==typeof n?n:n.url?n.url:n.data&&n.data.url?n.data.url:n.data?n.data:String(n),!c||"string"!=typeof c)throw new Error("无法从响应中提取有效的图片URL");return I.imageUrl=c,q.value={success:!0,message:"图片上传成功",url:c},"function"==typeof l&&l({url:c,...n}),u.success("图片上传成功"),{success:!0,url:c}}catch(s){const r=s.message||"图片上传失败";return q.value={success:!1,message:r},(null==e?void 0:e.onError)&&"function"==typeof e.onError&&e.onError({message:r}),u.error(r),Promise.reject(s)}},H=(e,r)=>{S.value=r,"success"===e.status?e.url&&e.url.trim()?I.musicUrl=e.url:I.musicUrl="":"error"===e.status||"removed"===e.status?I.musicUrl="":e.status},J=(e,r)=>{$.value=r,"success"===e.status?e.url&&e.url.trim()?I.imageUrl=e.url:I.imageUrl="":"error"===e.status||"removed"===e.status?I.imageUrl="":e.status},K=async()=>{const e=S.value[0];if(!e)return u.error("请选择音乐文件后再上传"),Promise.reject(new Error("未选择音乐文件"));q.value={success:!1,message:""},I.musicUrl="";try{return await D({file:e,onProgress:e=>{},onSuccess:e=>{},onError:e=>{}})}catch(r){return u.error(r.message||"音乐文件上传失败"),Promise.reject(r)}},O=async()=>{const e=$.value[0];if(!e)return u.error("请选择封面图片后再上传"),Promise.reject(new Error("未选择图片文件"));q.value={success:!1,message:""},I.imageUrl="";try{return await G({file:e,onProgress:e=>{},onSuccess:e=>{},onError:e=>{}})}catch(r){return u.error(r.message||"图片文件上传失败"),Promise.reject(r)}},Q=async()=>{var r,a;try{if(await M.value.validate(),!I.musicUrl||""===I.musicUrl.trim())return void u.error("请先上传音乐文件");const r={...I},a=t(),s=await e(r,a);if(!s||!s.data)throw new Error("API返回空结果");const l=s.data;if(!0!==l.success&&20!==l.code)throw new Error(l.message||"提交失败");u.success(l.message||"音乐信息添加成功"),I.musicUrl="",I.imageUrl="",S.value=[],$.value=[],q.value={success:!1,message:""},A.value=null,W(),setTimeout((()=>{router.push(router.currentRoute.value.fullPath)}),3e3)}catch(s){if(s.response){const e=(null==(r=s.response.data)?void 0:r.message)||(null==(a=s.response.data)?void 0:a.error)||"服务器处理失败";u.error(e)}else s.request?u.error("网络错误，请检查您的连接"):u.error(s.message||"提交失败，请重试")}},W=()=>{M.value&&M.value.resetFields(),I.musicUrl="",I.imageUrl="",S.value=[],$.value=[],q.value={success:!1,message:""},A.value=null},X=e=>{const r=e%60;return`${Math.floor(e/60)}:${r<10?"0":""}${r}`};return(e,r)=>{const a=m("el-button"),s=m("el-upload"),t=m("el-form-item"),l=m("el-input"),u=m("el-form"),o=m("el-alert"),i=m("el-descriptions-item"),n=m("el-descriptions");return d(),g("div",b,[r[11]||(r[11]=f("h2",null,"发布音乐",-1)),p(u,{model:I,rules:L,ref_key:"musicFormRef",ref:M,"label-width":"120px",class:"music-form"},{default:v((()=>[p(t,{label:"选择音乐文件"},{tip:v((()=>[...r[6]||(r[6]=[f("div",{class:"el-upload__tip"}," 只能上传 mp3/wav/flac/m4a 格式的音频文件，且不超过 10MB，最多上传1个文件 ",-1)])])),default:v((()=>[f("div",_,[p(s,{action:"","before-upload":z,"http-request":D,"before-remove":N,"auto-upload":!1,"file-list":S.value,accept:".mp3,.wav,.flac,.m4a",onChange:H,limit:1,"on-exceed":C,"list-type":"text"},{default:v((()=>[p(a,{type:"primary"},{default:v((()=>[...r[4]||(r[4]=[h("选择文件",-1)])])),_:1})])),_:1},8,["file-list"]),p(a,{type:"primary",onClick:K},{default:v((()=>[...r[5]||(r[5]=[h(" 上传 ",-1)])])),_:1})])])),_:1}),p(t,{label:"音乐名称",prop:"musicName"},{default:v((()=>[p(l,{modelValue:I.musicName,"onUpdate:modelValue":r[0]||(r[0]=e=>I.musicName=e),placeholder:"请输入音乐名称"},null,8,["modelValue"])])),_:1}),p(t,{label:"歌手用户名",prop:"singerUsername"},{default:v((()=>[p(l,{modelValue:I.singerUsername,"onUpdate:modelValue":r[1]||(r[1]=e=>I.singerUsername=e),placeholder:" ",disabled:""},null,8,["modelValue"])])),_:1}),p(t,{label:"图片URL"},{tip:v((()=>[...r[9]||(r[9]=[f("div",{class:"el-upload__tip"}," 只能上传 jpg/jpeg/png/gif 格式的图片文件，且不超过 5MB，最多上传1个文件 ",-1)])])),default:v((()=>[f("div",E,[p(s,{action:"","before-upload":T,"http-request":G,"before-remove":N,"auto-upload":!1,"file-list":$.value,accept:".jpg,.jpeg,.png,.gif",onChange:J,limit:1,"on-exceed":C,"list-type":"text"},{default:v((()=>[p(a,{type:"primary"},{default:v((()=>[...r[7]||(r[7]=[h("选择封面",-1)])])),_:1})])),_:1},8,["file-list"]),p(a,{type:"primary",onClick:O},{default:v((()=>[...r[8]||(r[8]=[h(" 上传 ",-1)])])),_:1})])])),_:1}),p(t,{label:"封面预览"},{default:v((()=>[I.imageUrl?(d(),g("div",j,[f("img",{src:I.imageUrl,alt:"音乐封面",style:{"max-width":"200px","max-height":"200px"}},null,8,x)])):(d(),g("div",P," 暂无封面图片 "))])),_:1}),p(t,{label:"音乐URL"},{default:v((()=>[p(l,{modelValue:I.musicUrl,"onUpdate:modelValue":r[2]||(r[2]=e=>I.musicUrl=e),placeholder:" ",readonly:"",disabled:""},null,8,["modelValue"])])),_:1}),p(t,{label:"图片URL"},{default:v((()=>[p(l,{modelValue:I.imageUrl,"onUpdate:modelValue":r[3]||(r[3]=e=>I.imageUrl=e),placeholder:" ",readonly:"",disabled:""},null,8,["modelValue"])])),_:1}),p(t,null,{default:v((()=>[f("div",V,[p(a,{type:"success",onClick:Q},{default:v((()=>[...r[10]||(r[10]=[h(" 提交音乐信息 ",-1)])])),_:1})])])),_:1})])),_:1},8,["model"]),q.value?(d(),g("div",k,[q.value.success?(d(),y(o,{key:0,title:q.value.message,type:"success","show-icon":""},null,8,["title"])):w("",!0),q.value.success&&q.value.data?(d(),g("div",R,[p(n,{border:""},{default:v((()=>[p(i,{label:"URL"},{default:v((()=>[h(U(q.value.data.url),1)])),_:1}),q.value.data.timelength?(d(),y(i,{key:0,label:"音乐时长"},{default:v((()=>[h(U(X(q.value.data.timelength)),1)])),_:1})):w("",!0)])),_:1})])):w("",!0)])):w("",!0),A.value?(d(),g("div",F,[p(o,{title:A.value.message,type:A.value.success?"success":"error","show-icon":""},null,8,["title","type"])])):w("",!0)])}}},[["__scopeId","data-v-3ff9e355"]]);export{I as default};
