import{E as e,u as a,o as l}from"./element-plus.c63ee1ff.js";import{g as t,a as s,m as u,b as r}from"./msg.2d383b74.js";import{_ as o}from"./index.cfbf38c0.js";import{r as i,j as d,c as n,o as m,ac as v,y as c,D as g,G as p,E as f,F as y,z as h,R as _,M as w,a5 as b,S as k,U as x,u as V,H as D}from"./vendor.1112e821.js";import"./axios.468b7dd2.js";const T={class:"container"},C={class:"header"},I={class:"header-actions"},R={key:0,class:"badge"},S={class:"message-container"},U={key:2,class:"message-list"},j=["onClick"],F={class:"message-header"},M={class:"message-title"},$={class:"message-time"},q={class:"message-preview"},E={key:0},z={class:"dialog-header"},A={class:"dialog-time"},H={class:"dialog-content"},N={key:1,class:"empty-dialog"};var G=o({__name:"Index",setup(o){const G=i([]),P=i(0),Y=i(!1),B=i(!1),J=i(!1),K=i(!1),L=i(null),O=i(null),Q=i({title:"",message:"",togroup:"",username:""}),W=d({title:[{required:!0,message:"请输入消息标题",trigger:"blur"},{max:50,message:"标题最多50个字符",trigger:"blur"}],message:[{required:!0,message:"请输入消息内容",trigger:"blur"},{max:200,message:"内容最多200个字符",trigger:"blur"}],togroup:[{required:!0,message:"请选择发送角色",trigger:"change"}],username:[{required:()=>"0"===Q.value.togroup,message:"请输入用户ID",trigger:"blur"}]}),X=n((()=>P.value>0)),Z=async()=>{var a,l,s,u;if(!Y.value){Y.value=!0;try{const r=await t();(null==(a=null==r?void 0:r.data)?void 0:a.success)?(G.value=Array.isArray(null==(s=null==(l=r.data)?void 0:l.data)?void 0:s.msg)?r.data.data.msg:[],G.value.sort(((e,a)=>{const l=e.createTime?new Date(e.createTime).getTime():0;return(a.createTime?new Date(a.createTime).getTime():0)-l})),G.value.forEach((e=>{void 0===e.isRead&&(e.isRead=1)}))):e.error((null==(u=null==r?void 0:r.data)?void 0:u.message)||"获取消息失败，请检查网络连接")}catch(r){e.error("获取消息失败，请稍后重试")}finally{Y.value=!1}}},ee=async()=>{await Z(),await ae()},ae=async()=>{var e,a,l;try{const t=await s();(null==(e=null==t?void 0:t.data)?void 0:e.success)&&(P.value=parseInt(null==(l=null==(a=t.data)?void 0:a.data)?void 0:l.unReadMsg)||0)}catch(t){}},le=async()=>{var a,l;if(X.value)try{const t=await u();(null==(a=null==t?void 0:t.data)?void 0:a.success)?(e.success("已全部标记为已读"),G.value.forEach((e=>{e.isRead=1})),P.value=0):e.error((null==(l=null==t?void 0:t.data)?void 0:l.message)||"标记失败，请稍后重试")}catch(t){e.error("标记失败，请稍后重试")}},te=((e,a)=>{let l=null;return function(...t){l&&clearTimeout(l),l=setTimeout((()=>{e.apply(this,t)}),a)}})((e=>{e&&(L.value={...e},J.value=!0,0===e.isRead&&P.value>0&&(e.isRead=1,P.value=Math.max(0,P.value-1)))}),200),se=async()=>{var a,l;try{await O.value.validate();const t={title:Q.value.title.trim(),message:Q.value.message.trim(),togroup:"0"===Q.value.togroup?"":Q.value.togroup,username:"0"===Q.value.togroup?Q.value.username.trim():null};if("0"===Q.value.togroup&&!t.username)return void e.warning("请输入用户ID");B.value=!0;const s=await r(t.title,t.message,t.togroup,t.username);(null==(a=null==s?void 0:s.data)?void 0:a.success)?(e.success("发送成功"),Q.value={title:"",message:"",togroup:"",username:""},O.value.resetFields(),ue(),Z()):e.error("发送失败: "+((null==(l=null==s?void 0:s.data)?void 0:l.message)||"未知错误"))}catch(t){e.error("发送失败，请重试")}finally{B.value=!1}},ue=()=>{K.value=!1},re=()=>{Q.value.title="",Q.value.message="",Q.value.togroup="",Q.value.username="",O.value&&O.value.resetFields(),ue()},oe=e=>{if(!e)return"时间未知";try{const a=new Date(e);return isNaN(a.getTime())?"时间格式错误":`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")} ${String(a.getHours()).padStart(2,"0")}:${String(a.getMinutes()).padStart(2,"0")}`}catch(a){return"时间未知"}};return m((async()=>{try{await Promise.all([Z(),ae()])}catch(e){}})),(e,t)=>{const s=v("el-button"),u=v("el-icon"),r=v("el-empty"),o=v("el-dialog"),i=v("el-input"),d=v("el-form-item"),n=v("el-option"),m=v("el-select"),X=v("el-form");return c(),g("div",T,[p("div",C,[t[11]||(t[11]=p("h2",null,"消息中心",-1)),p("div",I,[f(s,{type:"primary",onClick:ee},{default:y((()=>[...t[8]||(t[8]=[k(" 刷新 ",-1)])])),_:1}),f(s,{type:"primary",onClick:t[0]||(t[0]=e=>K.value=!0)},{default:y((()=>[...t[9]||(t[9]=[k(" 发送消息 ",-1)])])),_:1}),P.value>0?(c(),h(s,{key:0,onClick:le},{default:y((()=>[t[10]||(t[10]=k(" 全部标记已读 ",-1)),P.value>0?(c(),g("span",R,x(P.value),1)):_("",!0)])),_:1})):_("",!0)])]),p("div",S,[Y.value?(c(),h(r,{key:0,description:"加载中..."},{default:y((()=>[f(u,{size:"40",color:"#409eff"},{default:y((()=>[f(V(Y))])),_:1})])),_:1})):0===G.value.length?(c(),h(r,{key:1,description:"暂无消息"},{default:y((()=>[f(s,{type:"primary",onClick:Z},{default:y((()=>[...t[12]||(t[12]=[k("刷新",-1)])])),_:1})])),_:1})):(c(),g("div",U,[(c(!0),g(w,null,b(G.value,(e=>{return c(),g("div",{key:e.id,class:D(["message-item",{unread:0===e.isRead}]),onClick:a=>V(te)(e)},[p("div",F,[p("span",M,x(e.title||"无标题消息"),1),p("span",$,x(oe(e.createTime)),1)]),p("div",q,x((a=e.msg||"无内容",l=100,a&&"string"==typeof a?a.length<=l?a:a.substring(0,l)+"...":"")),1)],10,j);var a,l})),128))]))]),f(o,{modelValue:J.value,"onUpdate:modelValue":t[1]||(t[1]=e=>J.value=e),title:"消息详情",width:"600px"},{default:y((()=>[L.value?(c(),g("div",E,[p("div",z,[p("h3",null,x(L.value.title||"无标题消息"),1),p("span",A,x(oe(L.value.createTime)),1)]),p("div",H,[p("p",null,x(L.value.msg||"无内容"),1)])])):(c(),g("div",N,[...t[13]||(t[13]=[p("p",null,"消息内容加载失败",-1)])]))])),_:1},8,["modelValue"]),f(o,{modelValue:K.value,"onUpdate:modelValue":t[7]||(t[7]=e=>K.value=e),title:"发送消息",width:"600px","close-on-click-modal":!1},{footer:y((()=>[f(s,{onClick:re},{default:y((()=>[...t[16]||(t[16]=[k("取消",-1)])])),_:1}),f(s,{type:"primary",loading:B.value,onClick:se},{default:y((()=>[...t[17]||(t[17]=[k("发送",-1)])])),_:1},8,["loading"])])),default:y((()=>[f(X,{ref_key:"sendFormRef",ref:O,model:Q.value,rules:W,"label-width":"80px"},{default:y((()=>[f(d,{label:"消息标题",prop:"title"},{default:y((()=>[f(i,{modelValue:Q.value.title,"onUpdate:modelValue":t[2]||(t[2]=e=>Q.value.title=e),placeholder:"请输入消息标题",maxlength:"50","show-word-limit":""},null,8,["modelValue"])])),_:1}),f(d,{label:"消息内容",prop:"message"},{default:y((()=>[f(i,{modelValue:Q.value.message,"onUpdate:modelValue":t[3]||(t[3]=e=>Q.value.message=e),type:"textarea",rows:"4",placeholder:"请输入消息内容",maxlength:"500","show-word-limit":""},null,8,["modelValue"])])),_:1}),f(d,{label:"发送角色",prop:"togroup"},{default:y((()=>[f(m,{modelValue:Q.value.togroup,"onUpdate:modelValue":t[4]||(t[4]=e=>Q.value.togroup=e),placeholder:"请选择发送角色"},{default:y((()=>[f(n,{label:"全体用户",value:"2"}),f(n,{label:"全体歌手",value:"1"}),f(n,{label:"特定用户",value:"0"})])),_:1},8,["modelValue"])])),_:1}),"0"===Q.value.togroup?(c(),h(d,{key:0,label:"用户ID",prop:"username"},{default:y((()=>[f(i,{modelValue:Q.value.username,"onUpdate:modelValue":t[6]||(t[6]=e=>Q.value.username=e),placeholder:"请输入用户ID",maxlength:"50","show-word-limit":""},{prefix:y((()=>[f(u,null,{default:y((()=>[f(V(a))])),_:1})])),suffix:y((()=>[Q.value.username?(c(),h(u,{key:0,class:"el-input__icon",onClick:t[5]||(t[5]=e=>Q.value.username="")},{default:y((()=>[f(V(l))])),_:1})):_("",!0)])),_:1},8,["modelValue"]),t[14]||(t[14]=p("div",{class:"help-text"},"请输入接收消息的具体用户ID",-1))])),_:1})):_("",!0),t[15]||(t[15]=p("div",{class:"help-text"},"选择'所有人'或'歌手'向对应角色的用户群组发送消息，或选择'特定用户'向单个用户ID发送消息",-1))])),_:1},8,["model","rules"])])),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-4c96c9ba"]]);export{G as default};
