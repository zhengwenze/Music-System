import{r as e,j as a,o as r,ac as l,ad as t,y as s,D as o,E as d,F as i,G as u,S as n,am as m,P as c,z as p,U as g,R as h}from"./vendor.1112e821.js";import{_ as f,i as v,r as w}from"./index.cfbf38c0.js";import{u as y}from"./admin.d2f1ae71.js";import{E as b,i as C}from"./element-plus.c63ee1ff.js";import"./axios.468b7dd2.js";const V={class:"user-management-container"},_={class:"card-header"},x={class:"search-box"},F={key:1},U={class:"dialog-footer"};var k=f({name:"UserManagement",setup(){const l=e([]),t=e(!1),s=e(0),o=e(1),d=e(5),i=e(""),u=e(!1),n=e(""),m=e(null),c=e(!1),p=a({id:null,username:"",email:"",phone:"",password:"",confirmPassword:"",role:"2",status:"1"}),g=(e,a,r)=>{""===a?r(new Error("请输入密码")):(""!==p.confirmPassword&&m.value.validateField("confirmPassword"),r())},h=(e,a,r)=>{""===a?r(new Error("请再次输入密码")):a!==p.password?r(new Error("两次输入密码不一致!")):r()},f=a({username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:20,message:"用户名长度在 3 到 20 个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入有效的邮箱地址",trigger:"blur"}],phone:[{required:!0,message:"请输入手机号",trigger:"blur"},{pattern:/^1[3-9]\d{9}$/,message:"请输入有效的手机号",trigger:"blur"}],password:[{required:!0,validator:g,trigger:"blur"},{min:6,max:20,message:"长度在 6 到 20 个字符",trigger:"blur"}],confirmPassword:[{required:!0,validator:h,trigger:"blur"}]}),V=async()=>{t.value=!0;try{const e=`/pageUser/1/${5*d.value}`,a=await v.get(e,{params:{keyword:i.value||""}});if(20===a.data.code||!0===a.data.success){let e=[];a.data.page&&a.data.page.records?e=a.data.page.records:a.data.data&&a.data.data.page&&a.data.data.page.records?e=a.data.data.page.records:a.data.records?e=a.data.records:Array.isArray(a.data)?e=a.data:a.data.list?e=a.data.list:a.data.data&&Array.isArray(a.data.data)&&(e=a.data.data);const r=e.filter((e=>e&&2===e.role));s.value=r.length;const t=(o.value-1)*d.value,i=t+d.value;if(l.value=r.slice(t,i),0===l.value.length&&s.value>0){const e=Math.ceil(s.value/d.value);if(e>0&&e!==o.value)return o.value=e,void(await V())}}else b.error(a.data.message||"获取用户列表失败")}catch(e){b.error("获取用户列表失败")}finally{t.value=!1}},_=()=>{p.id=null,p.username="",p.email="",p.phone="",p.password="",p.confirmPassword="",p.role="2",p.status="1",m.value&&m.value.resetFields()};return r((()=>{V()})),{userList:l,loading:t,total:s,currentPage:o,pageSize:d,searchKeyword:i,formatRole:e=>({0:"管理员",1:"歌手",2:"用户"}[e.role]||"未知"),handleSearch:()=>{o.value=1,V()},resetSearch:()=>{i.value="",o.value=1,V()},fresh:()=>{V()},toggleUserStatus:async e=>{var a,r,l,t,s;try{await C.confirm(`确定要${1===e.activation?"冻结":"解冻"}用户 "${e.username}" 吗？`,"确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});let o;o=1===e.activation?await v.post("/freezeUser",null,{params:{id:e.id}}):await v.post("/unfreezeUser",null,{params:{id:e.id}}),200===(null==(a=o.data)?void 0:a.code)||!0===(null==(r=o.data)?void 0:r.success)||20===(null==(l=o.data)?void 0:l.code)?(b.success((null==(t=o.data)?void 0:t.message)||(1===e.activation?"冻结":"解冻")+"成功"),V()):b.error((null==(s=o.data)?void 0:s.message)||(1===e.activation?"冻结":"解冻")+"失败")}catch(o){"cancel"===o||b.error("操作失败")}},handleSizeChange:e=>{d.value=e,o.value=1,V()},handleCurrentChange:e=>{o.value=e,V()},dialogVisible:u,dialogTitle:n,userForm:p,userFormRef:m,formRules:f,showAddForm:()=>{c.value=!1,n.value="添加用户",_(),u.value=!0},showEditForm:e=>{c.value=!0,n.value="编辑用户",Object.assign(p,e),u.value=!0},submitForm:async()=>{m.value&&(c.value?(f.password=[],f.confirmPassword=[]):(f.password=[{required:!0,validator:g,trigger:"blur"},{min:6,max:20,message:"长度在 6 到 20 个字符",trigger:"blur"}],f.confirmPassword=[{required:!0,validator:h,trigger:"blur"}]),await m.value.validate((async e=>{var a,r,l,t;if(!e)return!1;try{let e,s={...p};if(c.value)delete s.password,delete s.confirmPassword,e=await y(s.id,s);else{const a={username:p.username,email:p.email,phone:p.phone,password:p.password,role:"2"};e=await w(a)}20===(null==(a=e.data)?void 0:a.code)||!0===(null==(r=e.data)?void 0:r.success)?(b.success((null==(l=e.data)?void 0:l.message)||(c.value?"更新成功":"添加成功")),u.value=!1,V()):b.error((null==(t=e.data)?void 0:t.message)||(c.value?"更新失败":"添加失败"))}catch(s){b.error("操作失败")}})))},deleteUser:async e=>{try{await C.confirm(`确定要删除用户 "${e.username}" 吗？此操作不可恢复！`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"error"});const a=await v.post("/deleteUser",null,{params:{userId:e.id}});200===a.code||!0===a.success?(b.success(a.message||"删除成功"),V()):b.error(a.message||"删除失败")}catch(a){"cancel"!==a&&b.error("删除失败")}},isEditMode:c}}},[["render",function(e,a,r,f,v,w){const y=l("el-button"),b=l("el-input"),C=l("el-table-column"),k=l("el-image"),z=l("el-tag"),P=l("el-table"),S=l("el-pagination"),E=l("el-card"),j=l("el-form-item"),q=l("el-form"),R=l("el-dialog"),T=t("loading");return s(),o("div",V,[d(E,null,{default:i((()=>[u("div",_,[a[11]||(a[11]=u("h2",null,"用户管理",-1)),d(y,{type:"primary",onClick:f.showAddForm},{default:i((()=>[...a[10]||(a[10]=[n("添加用户",-1)])])),_:1},8,["onClick"])]),u("div",x,[d(b,{modelValue:f.searchKeyword,"onUpdate:modelValue":a[0]||(a[0]=e=>f.searchKeyword=e),placeholder:"请输入用户名进行搜索",style:{width:"300px","margin-right":"10px"},clearable:"",onKeyup:m(f.handleSearch,["enter"])},null,8,["modelValue","onKeyup"]),d(y,{type:"primary",onClick:f.handleSearch},{default:i((()=>[...a[12]||(a[12]=[n("搜索",-1)])])),_:1},8,["onClick"]),d(y,{onClick:f.resetSearch},{default:i((()=>[...a[13]||(a[13]=[n("重置",-1)])])),_:1},8,["onClick"]),d(y,{onClick:f.fresh},{default:i((()=>[...a[14]||(a[14]=[n("刷新",-1)])])),_:1},8,["onClick"])]),c((s(),p(P,{data:f.userList,style:{width:"100%","margin-top":"20px"},"default-sort":{prop:"id",order:"ascending"}},{default:i((()=>[d(C,{prop:"id",label:"ID",width:"50"}),d(C,{prop:"username",label:"用户名",width:"120"}),d(C,{label:"用户头像",width:"150"},{default:i((({row:e})=>[e.imageUrl?(s(),p(k,{key:0,src:e.imageUrl,"preview-src-list":[e.imageUrl],fit:"cover",style:{width:"80px",height:"80px","border-radius":"4px"}},null,8,["src","preview-src-list"])):(s(),o("span",F,"-"))])),_:1}),d(C,{prop:"email",label:"邮箱",width:"200"}),d(C,{prop:"phone",label:"手机号",width:"130"}),d(C,{prop:"role",label:"角色",formatter:f.formatRole,width:"80"},null,8,["formatter"]),d(C,{prop:"activation",label:"状态",width:"80"},{default:i((({row:e})=>[d(z,{type:1===e.activation?"success":"danger"},{default:i((()=>[n(g(1===e.activation?"正常":"冻结"),1)])),_:2},1032,["type"])])),_:1}),d(C,{prop:"createTime",label:"创建时间",width:"160"}),d(C,{label:"操作",width:"220"},{default:i((({row:e})=>[d(y,{size:"small",type:"primary",onClick:a=>f.showEditForm(e),style:{"margin-right":"5px"}},{default:i((()=>[...a[15]||(a[15]=[n(" 编辑 ",-1)])])),_:1},8,["onClick"]),d(y,{size:"small",type:1===e.activation?"danger":"success",onClick:a=>f.toggleUserStatus(e),style:{"margin-right":"5px"}},{default:i((()=>[n(g(1===e.activation?"冻结":"解冻"),1)])),_:2},1032,["type","onClick"])])),_:1})])),_:1},8,["data"])),[[T,f.loading]]),d(S,{"current-page":f.currentPage,"onUpdate:currentPage":a[1]||(a[1]=e=>f.currentPage=e),"page-size":f.pageSize,"onUpdate:pageSize":a[2]||(a[2]=e=>f.pageSize=e),"page-sizes":[5,10,20,50,100],total:f.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:f.handleSizeChange,onCurrentChange:f.handleCurrentChange,style:{"margin-top":"20px","justify-content":"center"}},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])),_:1}),d(R,{modelValue:f.dialogVisible,"onUpdate:modelValue":a[9]||(a[9]=e=>f.dialogVisible=e),title:f.dialogTitle,width:"500px"},{footer:i((()=>[u("span",U,[d(y,{onClick:a[8]||(a[8]=e=>f.dialogVisible=!1)},{default:i((()=>[...a[16]||(a[16]=[n("取消",-1)])])),_:1}),d(y,{type:"primary",onClick:f.submitForm},{default:i((()=>[...a[17]||(a[17]=[n("确定",-1)])])),_:1},8,["onClick"])])])),default:i((()=>[d(q,{ref:"userFormRef",model:f.userForm,rules:f.formRules,"label-width":"80px"},{default:i((()=>[d(j,{label:"用户名",prop:"username"},{default:i((()=>[d(b,{modelValue:f.userForm.username,"onUpdate:modelValue":a[3]||(a[3]=e=>f.userForm.username=e),placeholder:"请输入用户名"},null,8,["modelValue"])])),_:1}),d(j,{label:"邮箱",prop:"email"},{default:i((()=>[d(b,{modelValue:f.userForm.email,"onUpdate:modelValue":a[4]||(a[4]=e=>f.userForm.email=e),placeholder:"请输入邮箱",type:"email"},null,8,["modelValue"])])),_:1}),d(j,{label:"手机号",prop:"phone"},{default:i((()=>[d(b,{modelValue:f.userForm.phone,"onUpdate:modelValue":a[5]||(a[5]=e=>f.userForm.phone=e),placeholder:"请输入手机号"},null,8,["modelValue"])])),_:1}),f.isEditMode?h("",!0):(s(),p(j,{key:0,label:"密码",prop:"password"},{default:i((()=>[d(b,{modelValue:f.userForm.password,"onUpdate:modelValue":a[6]||(a[6]=e=>f.userForm.password=e),type:"password",placeholder:"请输入密码","show-password":""},null,8,["modelValue"])])),_:1})),f.isEditMode?h("",!0):(s(),p(j,{key:1,label:"确认密码",prop:"confirmPassword"},{default:i((()=>[d(b,{modelValue:f.userForm.confirmPassword,"onUpdate:modelValue":a[7]||(a[7]=e=>f.userForm.confirmPassword=e),type:"password",placeholder:"请再次输入密码","show-password":""},null,8,["modelValue"])])),_:1}))])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"])])}],["__scopeId","data-v-01d98a81"]]);export{k as default};
