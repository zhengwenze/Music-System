import{_ as e,g as a,a as o,s as l,b as r,u as s,c as d}from"./index.cfbf38c0.js";import{E as t}from"./element-plus.c63ee1ff.js";import{j as u,r as n,c as i,o as m,ac as p,y as c,D as w,G as f,E as g,F as b,S as v}from"./vendor.1112e821.js";import"./axios.468b7dd2.js";const h={class:"profile-container"},V=["src"],_={key:1,class:"el-icon-plus avatar-uploader-icon"},P={class:"dialog-footer"};var y=e({name:"Profile",setup(){const e=u({id:"",username:"",email:"",phone:"",image_url:"",createTime:"",updateTime:"",role:2,activation:0,about:""}),p=n(!1),c=n({}),w=n(!1),f=n({oldPassword:"",newPassword:"",confirmPassword:""}),g=n(null),b=n({oldPassword:[{required:!0,message:"请输入旧密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,max:20,message:"密码长度应在6-20位之间",trigger:"blur"},{validator:(e,a,o)=>{a===f.value.oldPassword?o(new Error("新密码不能与旧密码相同")):o()},trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(e,a,o)=>{a!==f.value.newPassword?o(new Error("两次输入的密码不一致")):o()},trigger:"blur"}]}),v=i((()=>{switch(e.role){case 0:return"管理员";case 1:return"歌手";case 2:return"用户";default:return"未知角色"}})),h=i((()=>1===e.activation?"已激活":"未激活")),V=async()=>{try{p.value=!0;const r=a();if(!r)return void t.error("用户未登录");const s=await o(r);if(s&&s.data&&(s.data.success||20===s.data.code)&&s.data.data&&s.data.data.user){const a=s.data.data.user;e.id=a.id||r,e.username=a.username||"",e.email=a.email||"",e.phone=a.phone||"",e.image_url=a.image_url||"",e.createTime=a.createTime||"",e.updateTime=a.updateTime||"",e.role=a.role||2,e.activation=a.activation||0,e.about=a.about||"",c.value={...e},l({userId:a.id,username:a.username,role:a.role,email:a.email,phone:a.phone,activation:a.activation,image_url:a.image_url})}else t.error("获取用户信息失败")}catch(r){t.error("获取用户信息失败，请重试")}finally{p.value=!1}};return m((()=>{V()})),{userInfo:e,loading:p,passwordDialogVisible:w,passwordForm:f,passwordFormRef:g,passwordFormRules:b,userRoleText:v,activationText:h,handleUpdate:async()=>{try{const a=await s({id:e.id,username:e.username,email:e.email,phone:e.phone,about:e.about});a&&a.data&&(a.data.success||20===a.data.code)?(t.success("保存成功"),c.value={...e},l({userId:e.id,username:e.username,email:e.email,phone:e.phone,image_url:e.image_url,about:e.about})):t.error(a&&a.data&&a.data.message||"保存失败")}catch(a){t.error("更新失败，请稍后重试")}},handleCancel:()=>{Object.assign(e,c.value)},updatePassword:()=>{f.value={oldPassword:"",newPassword:"",confirmPassword:""},g.value&&g.value.clearValidate(),w.value=!0},handlePasswordSubmit:async()=>{try{if(!g.value)return;await g.value.validate();const e=await d(f.value.oldPassword,f.value.newPassword);e&&e.data&&(e.data.success||20===e.data.code)?(t.success("密码修改成功"),w.value=!1):t.error(e&&e.data&&e.data.message||"密码修改失败")}catch(e){}},handleBeforeAvatarUpload:e=>{if(!/\.(jpg|jpeg|png|gif|bmp)$/i.test(e.name))return t.error("只支持上传图片格式（jpg、jpeg、png、gif、bmp）！"),!1;return!!(e.size/1024/1024<2)||(t.error("图片大小不能超过2MB！"),!1)},customAvatarUpload:async o=>{const{file:l}=o;try{if(!a())return t.error("用户未登录或会话已过期"),void(o.onError&&o.onError());const s=await r(l);if(s&&s.success)e.image_url=s.imageUrl,t.success("头像上传成功"),await V(),o.onSuccess&&o.onSuccess();else{const e=(null==s?void 0:s.message)||"更新头像失败";t.error(e),o.onError&&o.onError()}}catch(s){t.error("上传失败，请稍后重试"),o.onError&&o.onError(s)}}}}},[["render",function(e,a,o,l,r,s){const d=p("el-upload"),t=p("el-form-item"),u=p("el-input"),n=p("el-button"),i=p("el-form"),m=p("el-dialog");return c(),w("div",h,[a[16]||(a[16]=f("div",{class:"profile-header"},[f("h2",null,"个人信息")],-1)),g(i,{ref:"userForm",model:l.userInfo,"label-width":"120px"},{default:b((()=>[g(t,{label:"用户头像"},{default:b((()=>[g(d,{class:"avatar-uploader","http-request":l.customAvatarUpload,"before-upload":l.handleBeforeAvatarUpload,"show-file-list":!1},{default:b((()=>[l.userInfo.image_url?(c(),w("img",{key:0,src:l.userInfo.image_url,class:"avatar"},null,8,V)):(c(),w("i",_))])),_:1},8,["http-request","before-upload"])])),_:1}),g(t,{label:"用户名"},{default:b((()=>[g(u,{modelValue:l.userInfo.username,"onUpdate:modelValue":a[0]||(a[0]=e=>l.userInfo.username=e)},null,8,["modelValue"])])),_:1}),g(t,{label:"邮箱"},{default:b((()=>[g(u,{modelValue:l.userInfo.email,"onUpdate:modelValue":a[1]||(a[1]=e=>l.userInfo.email=e)},null,8,["modelValue"])])),_:1}),g(t,{label:"手机号"},{default:b((()=>[g(u,{modelValue:l.userInfo.phone,"onUpdate:modelValue":a[2]||(a[2]=e=>l.userInfo.phone=e)},null,8,["modelValue"])])),_:1}),g(t,{label:"用户角色"},{default:b((()=>[g(u,{modelValue:l.userRoleText,"onUpdate:modelValue":a[3]||(a[3]=e=>l.userRoleText=e),disabled:""},null,8,["modelValue"])])),_:1}),g(t,{label:"账户状态"},{default:b((()=>[g(u,{modelValue:l.activationText,"onUpdate:modelValue":a[4]||(a[4]=e=>l.activationText=e),disabled:""},null,8,["modelValue"])])),_:1}),g(t,{label:"注册时间"},{default:b((()=>[g(u,{modelValue:l.userInfo.createTime,"onUpdate:modelValue":a[5]||(a[5]=e=>l.userInfo.createTime=e),disabled:""},null,8,["modelValue"])])),_:1}),g(t,{label:"个人简介"},{default:b((()=>[g(u,{modelValue:l.userInfo.about,"onUpdate:modelValue":a[6]||(a[6]=e=>l.userInfo.about=e),type:"textarea",rows:1,maxlength:"15","show-word-limit":"",placeholder:"请输入个人简介"},null,8,["modelValue"])])),_:1}),g(t,null,{default:b((()=>[g(n,{type:"primary",onClick:l.handleUpdate},{default:b((()=>[...a[12]||(a[12]=[v("保存修改",-1)])])),_:1},8,["onClick"]),g(n,{type:"danger",onClick:l.updatePassword},{default:b((()=>[...a[13]||(a[13]=[v("修改密码",-1)])])),_:1},8,["onClick"])])),_:1})])),_:1},8,["model"]),g(m,{modelValue:l.passwordDialogVisible,"onUpdate:modelValue":a[11]||(a[11]=e=>l.passwordDialogVisible=e),title:"修改密码",width:"400px","close-on-click-modal":!1},{footer:b((()=>[f("span",P,[g(n,{onClick:a[10]||(a[10]=e=>l.passwordDialogVisible=!1)},{default:b((()=>[...a[14]||(a[14]=[v("取消",-1)])])),_:1}),g(n,{type:"primary",onClick:l.handlePasswordSubmit},{default:b((()=>[...a[15]||(a[15]=[v("确认修改",-1)])])),_:1},8,["onClick"])])])),default:b((()=>[g(i,{ref:"passwordFormRef",model:l.passwordForm,rules:l.passwordFormRules,"label-width":"100px",class:"password-form"},{default:b((()=>[g(t,{label:"旧密码",prop:"oldPassword",class:"password-form-item"},{default:b((()=>[g(u,{modelValue:l.passwordForm.oldPassword,"onUpdate:modelValue":a[7]||(a[7]=e=>l.passwordForm.oldPassword=e),type:"password",placeholder:"请输入旧密码","show-password":"",class:"password-input"},null,8,["modelValue"])])),_:1}),g(t,{label:"新密码",prop:"newPassword",class:"password-form-item"},{default:b((()=>[g(u,{modelValue:l.passwordForm.newPassword,"onUpdate:modelValue":a[8]||(a[8]=e=>l.passwordForm.newPassword=e),type:"password",placeholder:"请输入新密码","show-password":"",class:"password-input"},null,8,["modelValue"])])),_:1}),g(t,{label:"确认密码",prop:"confirmPassword",class:"password-form-item"},{default:b((()=>[g(u,{modelValue:l.passwordForm.confirmPassword,"onUpdate:modelValue":a[9]||(a[9]=e=>l.passwordForm.confirmPassword=e),type:"password",placeholder:"请确认新密码","show-password":"",class:"password-input"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])),_:1},8,["modelValue"])])}],["__scopeId","data-v-5c0812da"]]);export{y as default};
