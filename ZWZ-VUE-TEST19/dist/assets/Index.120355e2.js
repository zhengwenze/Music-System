import{_ as e,e as a}from"./index.cfbf38c0.js";import{g as r,u as l,d as t}from"./singer.7d3633a2.js";import{a as s,u as i}from"./upload.2e887d46.js";import{E as o,i as u}from"./element-plus.c63ee1ff.js";import{aA as n,r as c,j as m,o as d,ac as g,ad as p,y as f,D as h,E as v,F as w,n as y,G as U,P as b,z as _,S as x,U as C}from"./vendor.1112e821.js";import"./axios.468b7dd2.js";const F=n((()=>a((()=>import("./musicPlayer.10ac923a.js")),["assets/musicPlayer.10ac923a.js","assets/musicPlayer.78314e69.css","assets/index.cfbf38c0.js","assets/index.12a402db.css","assets/vendor.1112e821.js","assets/axios.468b7dd2.js","assets/element-plus.c63ee1ff.js"]))),E={class:"music-management-container"},P={key:1},I={style:{"margin-top":"20px","margin-left":"auto","margin-right":"auto",width:"80%"}},j={style:{display:"flex",gap:"10px","align-items":"center"}},V={style:{display:"flex",gap:"10px","align-items":"center"}},S={key:0,class:"image-preview"},M={key:1,class:"image-placeholder"},z={class:"dialog-footer"};var k=e({name:"SingerMusicManagement",components:{MusicPlayer:F},setup(){const e=c([]),a=c(!1),n=c(0),g=c(1),p=c(5),f=c(""),h=c(""),v=c(null),w=c(!1),U=c(""),b=c(null),_=c(!1),x=m({musicId:null,musicName:"",musicUrl:"",imageUrl:"",timeLength:null,listenNumb:0,fromSinger:null,tags:"",activation:0}),C=c([]),F=c([]),E=c(null),P=m({musicId:[{validator:(e,a,r)=>{!_.value||a&&null!==a?r():r(new Error("音乐ID不能为空"))},trigger:"blur"}],musicName:[{required:!0,message:"请输入音乐名称",trigger:"blur"},{min:1,max:50,message:"音乐名称长度在 1 到 50 个字符",trigger:"blur"}],musicUrl:[{required:!0,message:"请上传音乐文件",trigger:"blur"}],imageUrl:[{required:!0,message:"请上传封面图片",trigger:"blur"}]}),I=async()=>{a.value=!0;try{const l=(await r()).data;if(200===l.code||!0===l.success||20===l.code){const a=l.data;e.value=a.songs||[],n.value=a.songs?a.songs.length:0}else o.error(l.message||"获取音乐列表失败")}catch(l){o.error("获取音乐列表失败")}finally{a.value=!1}},j=()=>{x.musicId=null,x.musicName="",x.musicUrl="",x.imageUrl="",x.timeLength=null,x.fromSinger=null,x.tags="",x.listenNumb=0,x.activation=0,b.value&&b.value.resetFields(),C.value=[],F.value=[],E.value=null},V=async e=>{try{if(!e||"object"!=typeof e)throw new Error("无效的选项参数");const{file:a,onProgress:r,onSuccess:l,onError:t}=e;let i=a;if(!a)throw new Error("无效的文件对象：文件参数为空");if(a instanceof File)i=a;else{if(!(a.raw&&a.raw instanceof File))throw new Error("无效的文件对象：不是File实例且没有有效的raw属性");i=a.raw}const o=e=>{if(e.total){const l=Math.round(100*e.loaded/e.total);r&&r({percent:l}),a&&(a.percentage=l)}},u=await s(i,o);if(!u)throw new Error("API返回空结果");const n=u||{};let c=!1,m="",d=0;if(n.url?(c=!0,m=n.url,d=n.timelength||0):(!0===n.success||20===n.code)&&n.data&&n.data.url&&(c=!0,m=n.data.url,d=n.data.timelength||0),c){if(!m||""===m.trim())throw new Error("API返回的数据中没有有效的URL");const e={success:!0,message:n.message||"音乐文件上传成功",data:{url:m,timelength:d}};return E.value=e,x.musicUrl=m,d>0&&(x.timeLength=d),a&&(a.status="success",a.url=m,a.percentage=100),l&&l({status:"success",data:m}),Promise.resolve({status:"success",data:m})}{const e=n.message||"上传失败，API返回错误";throw new Error(e)}}catch(a){const r=a.message||"音乐文件上传失败";return E.value={success:!1,message:r},x.musicUrl="",e&&e.file&&(e.file.status="error",e.file.url="",e.file.percentage=0),e&&e.onError&&e.onError(a),o.error(r),Promise.reject(a)}},S=async e=>{try{if(!e||"object"!=typeof e)throw new Error("无效的选项参数");const{file:a,onProgress:r,onSuccess:l,onError:t}=e;let s=a;if(a instanceof File)s=a;else{if(!(a.raw&&a.raw instanceof File))throw new Error("无效的文件对象");s=a.raw}const u=await i(s);if(!u)throw new Error("API返回空结果");let n="";if("string"==typeof u)n=u;else if(u.url)n=u.url;else if(u.data&&u.data.url)n=u.data.url;else{if(!u.data)throw new Error("无法从响应中提取有效的图片URL");n=u.data}if(!n||"string"!=typeof n)throw new Error("无法从响应中提取有效的图片URL");return x.imageUrl=n,E.value={success:!0,message:"图片上传成功",url:n},a&&(a.status="success",a.url=n,a.percentage=100),l&&l({status:"success",data:n}),o.success("图片上传成功"),{success:!0,url:n}}catch(a){const r=a.message||"图片文件上传失败";return E.value={success:!1,message:r},x.imageUrl="",e&&e.file&&(e.file.status="error",e.file.url="",e.file.percentage=0),e&&e.onError&&e.onError(a),o.error(r),Promise.reject(a)}};return d((()=>{I()})),{musicList:e,loading:a,total:n,currentPage:g,pageSize:p,searchKeyword:f,handleSearch:()=>{g.value=1,I()},resetSearch:()=>{f.value="",g.value=1,I()},fresh:()=>{I()},handleDelete:async e=>{try{await u.confirm(`确定要删除歌曲 "${e.musicName}" 吗？此操作不可恢复！`,"确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const a=(await t(e.musicId)).data;200===a.code||!0===a.success||20===a.code?(o.success("删除成功"),I()):o.error(a.message||"删除失败")}catch(a){"cancel"===a||o.error("删除操作失败")}},handleSizeChange:e=>{p.value=e,g.value=1,I()},handleCurrentChange:e=>{g.value=e,I()},dialogVisible:w,dialogTitle:U,musicForm:x,musicFormRef:b,formRules:P,showAddForm:()=>{_.value=!1,U.value="添加音乐",j(),w.value=!0},showEditForm:e=>{_.value=!0,U.value="编辑音乐",Object.assign(x,e),w.value=!0},submitForm:async()=>{b.value&&await b.value.validate((async e=>{if(!e)return!1;try{let e,a={...x};if(!_.value)return;e=await l(a);const r=e.data;200===r.code||!0===r.success||20===r.code?(o.success(_.value?"更新成功":"添加成功"),w.value=!1,I()):o.error(r.message||(_.value?"更新失败":"添加失败"))}catch(a){o.error(_.value?"更新失败":"添加失败")}}))},isEditMode:_,formatDuration:e=>{if(!e||isNaN(e))return"00:00";const a=Math.floor(e/60),r=Math.floor(e%60);return`${a.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`},currentAudioUrl:h,musicPlayerRef:v,handlePlay:e=>{if(e.musicUrl){const r=(a=e.musicUrl)?a.startsWith("http://")||a.startsWith("https://")||a.startsWith("/")?a:`/music/${a}`:"";r?(h.value=r,y((()=>{v.value&&v.value.play().catch((e=>{}))}))):o.error("无效的音乐URL")}else o.error("音乐文件不存在");var a},musicFileList:C,imageFileList:F,uploadResult:E,beforeMusicUpload:e=>{if(!["audio/mpeg","audio/wav","audio/flac","audio/mp4"].includes(e.type))return o.error("上传文件必须是音频格式!"),!1;return!!(e.size/1024/1024<10)||(o.error("上传文件大小不能超过 10MB!"),!1)},customMusicUpload:V,handleMusicChange:(e,a)=>{C.value=a,"success"===e.status?e.url&&e.url.trim()?x.musicUrl=e.url:x.musicUrl="":("error"===e.status||"removed"===e.status)&&(x.musicUrl="")},handleMusicUpload:async()=>{const e=C.value[0];if(!e)return o.error("请选择音乐文件后再上传"),Promise.reject(new Error("未选择音乐文件"));E.value={success:!1,message:""},x.musicUrl="";try{return await V({file:e,onProgress:e=>{},onSuccess:e=>{},onError:e=>{}})}catch(a){return o.error(a.message||"音乐文件上传失败"),Promise.reject(a)}},beforeImageUpload:e=>{if(!["image/jpeg","image/png","image/gif"].includes(e.type))return o.error("上传文件必须是图片格式!"),!1;return!!(e.size/1024/1024<5)||(o.error("上传文件大小不能超过 5MB!"),!1)},customImageUpload:S,handleImageChange:(e,a)=>{F.value=a,"success"===e.status?e.url&&e.url.trim()?x.imageUrl=e.url:x.imageUrl="":("error"===e.status||"removed"===e.status)&&(x.imageUrl="")},handleImageUpload:async()=>{const e=F.value[0];if(!e)return o.error("请选择封面图片后再上传"),Promise.reject(new Error("未选择图片文件"));E.value={success:!1,message:""},x.imageUrl="";try{return await S({file:e,onProgress:e=>{},onSuccess:e=>{},onError:e=>{}})}catch(a){return o.error(a.message||"图片文件上传失败"),Promise.reject(a)}},handleExceed:(e,a)=>{o.warning(`当前限制选择 1 个文件，本次选择了 ${e.length} 个文件，共选择了 ${e.length+a.length} 个文件`)},beforeRemove:(e,a)=>u.confirm(`确定移除 ${e.name}？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).catch((()=>!1))}}},[["render",function(e,a,r,l,t,s){const i=g("el-table-column"),o=g("el-image"),u=g("el-button"),n=g("el-table"),c=g("MusicPlayer"),m=g("el-pagination"),d=g("el-card"),y=g("el-input"),F=g("el-form-item"),k=g("el-upload"),R=g("el-form"),L=g("el-dialog"),N=p("loading");return f(),h("div",E,[v(d,null,{default:w((()=>[a[12]||(a[12]=U("div",{class:"card-header"},[U("h2",null,"歌曲管理")],-1)),b((f(),_(n,{data:l.musicList,style:{"margin-top":"20px","margin-left":"auto","margin-right":"auto"},"default-sort":{prop:"musicId",order:"ascending"}},{default:w((()=>[v(i,{prop:"musicId",label:"ID",width:"50"}),v(i,{prop:"musicName",label:"音乐名称",width:"150"}),v(i,{label:"音乐封面",width:"150"},{default:w((({row:e})=>[e.imageUrl?(f(),_(o,{key:0,src:e.imageUrl,"preview-src-list":[e.imageUrl],fit:"cover",style:{width:"80px",height:"80px","border-radius":"4px"}},null,8,["src","preview-src-list"])):(f(),h("span",P,"-"))])),_:1}),v(i,{label:"歌手",width:"120"},{default:w((({row:e})=>[x(C(e.singerUsername||"-"),1)])),_:1}),v(i,{prop:"tags",label:"标签",width:"150","show-overflow-tooltip":""}),v(i,{prop:"createTime",label:"创建时间",width:"160"}),v(i,{label:"操作",width:"240"},{default:w((({row:e})=>[v(u,{size:"small",type:"default",style:{"margin-right":"5px"},onClick:a=>l.handlePlay(e)},{default:w((()=>[...a[9]||(a[9]=[x(" 播放 ",-1)])])),_:1},8,["onClick"]),v(u,{size:"small",type:"primary",onClick:a=>l.showEditForm(e),style:{"margin-right":"5px"}},{default:w((()=>[...a[10]||(a[10]=[x(" 编辑 ",-1)])])),_:1},8,["onClick"]),v(u,{size:"small",type:"danger",onClick:a=>l.handleDelete(e)},{default:w((()=>[...a[11]||(a[11]=[x(" 删除 ",-1)])])),_:1},8,["onClick"])])),_:1})])),_:1},8,["data"])),[[N,l.loading]]),U("div",I,[v(c,{ref:"musicPlayerRef","audio-url":l.currentAudioUrl},null,8,["audio-url"])]),v(m,{"current-page":l.currentPage,"onUpdate:currentPage":a[0]||(a[0]=e=>l.currentPage=e),"page-size":l.pageSize,"onUpdate:pageSize":a[1]||(a[1]=e=>l.pageSize=e),"page-sizes":[5,10,20,50,100],total:l.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:l.handleSizeChange,onCurrentChange:l.handleCurrentChange,style:{"margin-top":"20px","justify-content":"center"}},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])),_:1}),v(L,{modelValue:l.dialogVisible,"onUpdate:modelValue":a[8]||(a[8]=e=>l.dialogVisible=e),title:l.dialogTitle,width:"500px"},{footer:w((()=>[U("span",z,[v(u,{onClick:a[7]||(a[7]=e=>l.dialogVisible=!1)},{default:w((()=>[...a[19]||(a[19]=[x("取消",-1)])])),_:1}),v(u,{type:"primary",onClick:l.submitForm},{default:w((()=>[...a[20]||(a[20]=[x("确定",-1)])])),_:1},8,["onClick"])])])),default:w((()=>[v(R,{ref:"musicFormRef",model:l.musicForm,rules:l.formRules,"label-width":"80px"},{default:w((()=>[v(F,{label:"音乐ID",prop:"musicId"},{default:w((()=>[v(y,{modelValue:l.musicForm.musicId,"onUpdate:modelValue":a[2]||(a[2]=e=>l.musicForm.musicId=e),placeholder:"音乐ID",readonly:"",disabled:!0},null,8,["modelValue"])])),_:1}),v(F,{label:"音乐名称",prop:"musicName"},{default:w((()=>[v(y,{modelValue:l.musicForm.musicName,"onUpdate:modelValue":a[3]||(a[3]=e=>l.musicForm.musicName=e),placeholder:"请输入音乐名称"},null,8,["modelValue"])])),_:1}),v(F,{label:"标签",prop:"tags"},{default:w((()=>[v(y,{modelValue:l.musicForm.tags,"onUpdate:modelValue":a[4]||(a[4]=e=>l.musicForm.tags=e),placeholder:"请输入标签（用逗号分隔）"},null,8,["modelValue"])])),_:1}),v(F,{label:"选择音乐文件"},{tip:w((()=>[...a[15]||(a[15]=[U("div",{class:"el-upload__tip"}," 只能上传 mp3/wav/flac/m4a 格式的音频文件，且不超过 10MB，最多上传1个文件 ",-1)])])),default:w((()=>[U("div",j,[v(k,{action:"","before-upload":l.beforeMusicUpload,"http-request":l.customMusicUpload,"before-remove":l.beforeRemove,"auto-upload":!1,"file-list":l.musicFileList,accept:".mp3,.wav,.flac,.m4a",onChange:l.handleMusicChange,limit:1,"on-exceed":l.handleExceed},{default:w((()=>[v(u,{type:"primary"},{default:w((()=>[...a[13]||(a[13]=[x("选择文件",-1)])])),_:1})])),_:1},8,["before-upload","http-request","before-remove","file-list","onChange","on-exceed"]),v(u,{type:"primary",onClick:l.handleMusicUpload},{default:w((()=>[...a[14]||(a[14]=[x(" 上传 ",-1)])])),_:1},8,["onClick"])])])),_:1}),v(F,{label:"音乐URL",prop:"musicUrl"},{default:w((()=>[v(y,{modelValue:l.musicForm.musicUrl,"onUpdate:modelValue":a[5]||(a[5]=e=>l.musicForm.musicUrl=e),placeholder:" ",readonly:"",disabled:""},null,8,["modelValue"])])),_:1}),v(F,{label:"选择封面图片"},{tip:w((()=>[...a[18]||(a[18]=[U("div",{class:"el-upload__tip"}," 只能上传 jpg/jpeg/png/gif 格式的图片文件，且不超过 5MB，最多上传1个文件 ",-1)])])),default:w((()=>[U("div",V,[v(k,{action:"","before-upload":l.beforeImageUpload,"http-request":l.customImageUpload,"before-remove":l.beforeRemove,"auto-upload":!1,"file-list":l.imageFileList,accept:".jpg,.jpeg,.png,.gif",onChange:l.handleImageChange,limit:1,"on-exceed":l.handleExceed},{default:w((()=>[v(u,{type:"primary"},{default:w((()=>[...a[16]||(a[16]=[x("选择封面",-1)])])),_:1})])),_:1},8,["before-upload","http-request","before-remove","file-list","onChange","on-exceed"]),v(u,{type:"primary",onClick:l.handleImageUpload},{default:w((()=>[...a[17]||(a[17]=[x(" 上传 ",-1)])])),_:1},8,["onClick"])])])),_:1}),v(F,{label:"封面预览"},{default:w((()=>[l.musicForm.imageUrl?(f(),h("div",S,[v(o,{src:l.musicForm.imageUrl,"preview-src-list":[l.musicForm.imageUrl],fit:"cover",style:{width:"200px",height:"200px","border-radius":"4px"}},null,8,["src","preview-src-list"])])):(f(),h("div",M," 暂无封面图片 "))])),_:1}),v(F,{label:"图片URL",prop:"imageUrl"},{default:w((()=>[v(y,{modelValue:l.musicForm.imageUrl,"onUpdate:modelValue":a[6]||(a[6]=e=>l.musicForm.imageUrl=e),placeholder:" ",readonly:"",disabled:""},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])),_:1},8,["modelValue","title"])])}],["__scopeId","data-v-321a3454"]]);export{k as default};
